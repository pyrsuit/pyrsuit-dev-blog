<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- <link rel="icon" href="./favicon.png" /> -->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="./_app/immutable/assets/0.CczKcHiT.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/entry/start.D0gJyM2o.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/BbdFG1rr.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Dxtxyj28.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DK8D298C.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/JY5l5D6Y.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/eVigdbh7.js">
		<link rel="modulepreload" href="./_app/immutable/entry/app.D5q--n4I.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Bzak7iHL.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DHz2Y3yU.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CSz6k_A3.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/0.DRk75W90.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CcL8L1UM.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DLrSe-_4.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Bx_LN-Xl.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CcjtmNi5.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/3.BwJmtah3.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DuewSGYJ.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Dq1ptKLK.js"><!--[--><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300&amp;display=swap" rel="stylesheet"/><!--]-->
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><nav class="bg-yellow-50 p-4 flex justify-center gap-10 shadow-sm"><!--[--><a href="./" class="text-black tracking-wide text-center cursor-pointer transition-all duration-300 font-extralight hover:font-semibold svelte-1jhqufd" style="font-family: 'Montserrat', sans-serif;">About</a><a href="./feed" class="text-black tracking-wide text-center cursor-pointer transition-all duration-300 font-extralight hover:font-semibold svelte-1jhqufd" style="font-family: 'Montserrat', sans-serif;">Feed</a><a href="./til" class="text-black tracking-wide text-center cursor-pointer transition-all duration-300 font-extralight hover:font-semibold svelte-1jhqufd" style="font-family: 'Montserrat', sans-serif;">TIL</a><a href="./lab" class="text-black tracking-wide text-center cursor-pointer transition-all duration-300 font-extralight hover:font-semibold svelte-1jhqufd" style="font-family: 'Montserrat', sans-serif;">Lab</a><!--]--></nav> <main class="min-h-screen flex flex-col items-center justify-center bg-yellow-50 text-black px-4" style="font-family: 'Montserrat', sans-serif;"><!----><!----><section class="w-full max-w-5xl mx-auto px-6 pt-4 pb-16 space-y-8"><article><!----><div class="flex items-baseline justify-between mb-2">
  <h1 class="text-2xl font-light tracking-tight">A cookbook for a weather station — Part I</h1>
  <time class="text-sm text-gray-600 ml-4">September 1, 2025</time>
</div>

<p>Have you ever wondered how to measure <strong>temperature</strong> and <strong>humidity</strong>?</p>
<p>I decided to explore it by building my own setup from <strong>sensor</strong> to <strong>display</strong>:</p>
<div class="mermaid">flowchart TD
    ESP["🔌 NodeMCU ESP8266"] -->|Digital Pin| DHT["🌡️ DHT22 Sensor"]
    ESP -->|Wi-Fi / MQTT Publish| MQTT["📡 MQTT Broker"]

    subgraph "🍓 Raspberry Pi"
        direction TB
        MQTT
        Rust["🦀 Rust Logger"]
        DB["🗄️ SQLite Database"]
        HA["🏠 Home Assistant"]
    end

    Rust -->|Subscribes to topic| MQTT
    Rust -->|Writes data to| DB
    HA -->|Reads data from| MQTT</div><table>
<thead>
<tr>
<th>Hardware stack</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong><a href="https://store.arduino.cc/products/nodemcu-esp8266">NodeMCU ESP8266</a></strong></td>
<td>acts as the &quot;brain&quot; of the weather station - reads data from the sensor and forwards it via Wi-Fi</td>
</tr>
<tr>
<td><strong><a href="https://store.arduino.cc/products/grove-temperature-humidity-sensor-pro">DHT22</a></strong></td>
<td>measures <strong>temperature</strong> and <strong>humidity</strong></td>
</tr>
<tr>
<td><strong><a href="https://www.raspberrypi.com">Raspberry Pi</a></strong></td>
<td>hosts an <code>MQTT</code> client that receives weather data published via the <code>NodeMCU ESP8266</code> over Wi-Fi, allowing the data to be stored, processed, and shared</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Software stack</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong><a href="https://mqtt.org">MQTT</a></strong></td>
<td>messaging protocol for <code>IoT</code> using a publish/subscribe system</td>
</tr>
<tr>
<td><strong><a href="https://docs.arduino.cc/arduino-cloud/guides/arduino-c/">Arduino / C++</a></strong></td>
<td><code>NodeMCU ESP8266</code> runs <code>Arduino/C++</code> code to read data from the sensor and publish to the <code>MQTT</code> topics</td>
</tr>
<tr>
<td><strong><a href="https://www.home-assistant.io/integrations/sensor.mqtt/">Home Assistant</a></strong></td>
<td>subscribes to the <code>MQTT</code> topics to receive and display the measurements</td>
</tr>
<tr>
<td><strong><a href="https://sqlite.org">SQLite</a></strong></td>
<td>database to archive and store the weather station’s historical data on the <code>Raspberry Pi</code></td>
</tr>
<tr>
<td><strong><a href="https://www.rust-lang.org">Rust</a></strong></td>
<td>implements a logger that saves incoming <code>MQTT</code> weather data into the <code>SQLite</code> database</td>
</tr>
</tbody></table>
<h2>Assembling the sensor</h2>
<p>To connect a <code>DHT22</code> <strong>temperature</strong> and <strong>humidity</strong> sensor to the <code>NodeMCU ESP8266</code>, wire the <code>VCC</code> pin of the <code>DHT22</code> to the <code>NodeMCU ESP8266</code>’s <strong>3.3V</strong> pin and the <code>GND</code> pin to a <code>GND</code> pin on the <code>NodeMCU ESP8266</code>. Then connect the <code>Data</code> pin to the digital pin (<code>D2</code>) on the <code>NodeMCU ESP8266</code>.</p>
<p>If you want a visual walkthrough, Arduino provides an <a href="https://arduinogetstarted.com/tutorials/arduino-dht22">official tutorial</a> that covers this step-by-step.</p>
<h2>Retrieving <strong>temperature</strong> and <strong>humidity</strong> values</h2>
<p>The <code>NodeMCU ESP8266</code> and <code>DHT22</code> sensor work together: every 10 minutes, the device connects to Wi-Fi and syncs its clock with an <code>NTP</code> server to get the correct time:</p>

      <div class="code-block">
        <small class="language-label">cpp</small>
        <pre><code class="language-cpp">#include &lt;WiFiUdp.h&gt;
#include &lt;NTPClient.h&gt;

...

WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", 0, 60000);

...

timeClient.update();</code></pre>
      </div>
    <p>The <strong><a href="https://docs.arduino.cc/libraries/dht22/">DHT22</a></strong> library handles updating <strong>temperature</strong> and <strong>humidity</strong> values:</p>

      <div class="code-block">
        <small class="language-label">cpp</small>
        <pre><code class="language-cpp">#include &lt;DHT22.h&gt;

...

#define pinDATA SDA

...

DHT22 dht22(pinDATA);

...

float humidity = dht22.getHumidity();
float temperature = dht22.getTemperature();</code></pre>
      </div>
    <h2>Publishing data to <code>MQTT</code></h2>
<p>Since <code>NodeMCU ESP8266</code> has a Wi-Fi module, the measured values can be published to an <code>MQTT</code> client hosted on a <code>Raspberry Pi</code>.</p>
<p>The board first joins the Wi-Fi network:</p>

      <div class="code-block">
        <small class="language-label">cpp</small>
        <pre><code class="language-cpp">#include &lt;ESP8266WiFi.h&gt;

...

WiFiClient espClient;

...

const char* ssid = "ssid";
const char* password = "password";

...

void setup_wifi() {
  delay(10);
  Serial.println("Connecting to WiFi ...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi connected. IP: ");
  Serial.println(WiFi.localIP());
}</code></pre>
      </div>
    <p>With the Wi-Fi connection available, the board can publish data to the <code>MQTT</code>:</p>

      <div class="code-block">
        <small class="language-label">cpp</small>
        <pre><code class="language-cpp">#include <PubSubClient.h>

...

PubSubClient client(espClient);

...

const int mqtt_port = 1883;
const char* mqtt_server = "mqtt_server";

...

void reconnect() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection ...");
    if (client.connect("NodeMCUClient")) {
      Serial.println("connected");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" retrying in 5 seconds");
      delay(5000);
    }
  }
}

...

void setup() {
  Serial.begin(115200);
  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
  timeClient.begin();
}

...

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  timeClient.update();

  ...

}</code></pre>
      </div>
    <p>Sensor measurements are sent as <code>json</code> messages containing the <code>metric</code>, <code>value</code>, <code>unit</code>, <code>timestamp</code>, and published via <code>MQTT</code> to designated topics. Since the <code>NodeMCU ESP8266</code> transmits every 10 minutes, the buffer time is sufficient to capture all measurements.</p>

      <div class="code-block">
        <small class="language-label">cpp</small>
        <pre><code class="language-cpp">const char* mqtt_temperature_topic = "weather/indoor-sensor/temperature";
const char* mqtt_humidity_topic = "weather/indoor-sensor/humidity";

...

void loop() {
  // Check if readings are valid
  if (!isnan(humidity) && !isnan(temperature)) {
    unsigned long timestamp = timeClient.getEpochTime();

    // Prepare temperature payload as JSON
    String temperature_payload = "{\"metric\": \"temperature\", \"value\": " + String(temperature) + ", \"unit\": \"℃\", \"timestamp\": " + String((uint64_t)timestamp) + "}";

    // Prepare humidity payload as JSON
    String humidity_payload = "{\"metric\": \"humidity\", \"value\": " + String(humidity) + ", \"unit\": \"%\", \"timestamp\": " + String((uint64_t)timestamp) + "}";

    // Publish temperature
    client.publish(mqtt_temperature_topic, temperature_payload.c_str());
    Serial.println("Published temperature: " + temperature_payload);

    // Publish humidity
    client.publish(mqtt_humidity_topic, humidity_payload.c_str());
    Serial.println("Published humidity: " + humidity_payload);

  } else {
    Serial.println("Failed to read from DHT sensor");
  }

  delay(600000);

}</code></pre>
      </div>
    <h2>Syncing with <code>Home Assistant</code></h2>
<p>Once the data lands in <code>MQTT</code>, the measurements can be displayed in <code>Home Assistant</code> configuring <a href="https://www.home-assistant.io/integrations/sensor.mqtt/">MQTT Sensor</a>.</p>
<h2>Up next</h2>
<p>In the next part, I’ll dive into my <code>Rust</code>-based logger and share how it works. S</p>
<p>Stay tuned, Pyrsuers! 🐍</p>
<p><em>If you would like to check out the entire project, it is available in my <a href="https://github.com/pyrsuit/weather-station/tree/main">weather-station</a> repo.</em></p>
<!----></article></section><!----><!----></main><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_166pqgq = {
						base: new URL(".", location).pathname.slice(0, -1),
						assets: "/pyrsuit-dev-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("./_app/immutable/entry/start.D0gJyM2o.js"),
						import("./_app/immutable/entry/app.D5q--n4I.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data: [null,null],
							form: null,
							error: null,
							remote: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
